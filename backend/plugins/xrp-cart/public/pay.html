<!DOCTYPE html>
<html>
<!-- https://bbbootstrap.com/snippets/multi-step-form-wizard-30467045 -->

<head>
  <meta charset="UTF-8" />
  <title>XRP Cart</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />

  <style>
    * {
      margin: 0;
      padding: 0
    }

    html {
      height: 100%
    }

    body {
      background-color: rgb(238 242 255);
    }

    #grad1 {
      background-color: rgb(199 210 254);
      background-image: linear-gradient(180deg, rgb(224 231 255), rgb(238 242 255))
    }

    #msform {
      text-align: center;
      position: relative;
      margin-top: 20px
    }

    #msform fieldset .form-card {
      background: white;
      border: 0 none;
      border-radius: 0px;
      box-shadow: 0 2px 2px 2px rgba(0, 0, 0, 0.1);
      border-radius: 0.5rem;
      padding: 20px 40px 30px 40px;
      box-sizing: border-box;
      width: 94%;
      margin: 0 3% 20px 3%;
      position: relative
    }

    #msform fieldset {
      background: white;
      border: 0 none;
      border-radius: 0.5rem;
      box-sizing: border-box;
      width: 100%;
      margin: 0;
      padding-bottom: 20px;
      position: relative
    }

    #msform fieldset:not(:first-of-type) {
      display: none
    }

    #msform fieldset .form-card {
      text-align: left;
      color: #9E9E9E
    }

    #msform input,
    #msform textarea {
      padding: 0px 8px 4px 8px;
      border: none;
      border-bottom: 1px solid #ccc;
      border-radius: 0px;
      margin-bottom: 25px;
      margin-top: 2px;
      width: 100%;
      box-sizing: border-box;
      /* font-family: montserrat; */
      color: #2C3E50;
      font-size: 16px;
      letter-spacing: 1px
    }

    #msform input:focus,
    #msform textarea:focus {
      -moz-box-shadow: none !important;
      -webkit-box-shadow: none !important;
      box-shadow: none !important;
      border: none;
      font-weight: bold;
      border-bottom: 2px solid rgb(99 102 241);
      outline-width: 0
    }

    #msform .action-button {
      width: 100px;
      background: rgb(99 102 241);
      font-weight: bold;
      color: white;
      border: 0 none;
      border-radius: 0px;
      cursor: pointer;
      padding: 10px 5px;
      margin: 10px 5px
    }

    #msform .action-button:hover,
    #msform .action-button:focus {
      box-shadow: 0 0 0 2px white, 0 0 0 3px rgb(99 102 241)
    }

    #msform .action-button-previous {
      width: 100px;
      background: #616161;
      font-weight: bold;
      color: white;
      border: 0 none;
      border-radius: 0px;
      cursor: pointer;
      padding: 10px 5px;
      margin: 10px 5px
    }

    #msform .action-button-previous:hover,
    #msform .action-button-previous:focus {
      box-shadow: 0 0 0 2px white, 0 0 0 3px #616161
    }

    select.list-dt {
      border: none;
      outline: 0;
      border-bottom: 1px solid #ccc;
      padding: 2px 5px 3px 5px;
      margin: 2px
    }

    select.list-dt:focus {
      border-bottom: 2px solid rgb(99 102 241)
    }

    .card {
      z-index: 0;
      border: none;
      border-radius: 0.5rem;
      position: relative
    }

    .fs-title {
      font-size: 25px;
      color: #2C3E50;
      margin-bottom: 10px;
      font-weight: bold;
      text-align: left
    }

    #progressbar {
      margin-bottom: 30px;
      overflow: hidden;
      color: lightgrey
    }

    #progressbar .active {
      color: #000000
    }

    #progressbar li {
      list-style-type: none;
      font-size: 12px;
      width: 25%;
      float: left;
      position: relative
    }

    #progressbar #summary:before {
      font-family: FontAwesome;
      content: "\f022"
    }

    #progressbar #payment:before {
      font-family: FontAwesome;
      content: "\f09d"
    }

    #progressbar #approve:before {
      font-family: FontAwesome;
      content: "\f04c"
    }

    #progressbar #finish:before {
      font-family: FontAwesome;
      content: "\f00c"
    }

    #progressbar li:before {
      width: 50px;
      height: 50px;
      line-height: 45px;
      display: block;
      font-size: 18px;
      color: #ffffff;
      background: lightgray;
      border-radius: 50%;
      margin: 0 auto 10px auto;
      padding: 2px
    }

    #progressbar li:after {
      content: '';
      width: 100%;
      height: 2px;
      background: lightgray;
      position: absolute;
      left: 0;
      top: 25px;
      z-index: -1
    }

    #progressbar li.active:before,
    #progressbar li.active:after {
      background: rgb(99 102 241)
    }

    .radio-group {
      position: relative;
      margin-bottom: 25px
    }

    .radio {
      display: inline-block;
      width: 204;
      height: 104;
      border-radius: 0;
      background: lightblue;
      box-shadow: 0 2px 2px 2px rgba(0, 0, 0, 0.2);
      box-sizing: border-box;
      cursor: pointer;
      margin: 8px 2px
    }

    .radio:hover {
      box-shadow: 2px 2px 2px 2px rgba(0, 0, 0, 0.3)
    }

    .radio.selected {
      box-shadow: 1px 1px 2px 2px rgba(0, 0, 0, 0.1)
    }

    .fit-image {
      width: 100%;
      object-fit: cover
    }
  </style>

  <script src="https://unpkg.com/xrpl@2.1.0-beta.1"></script>
</head>

<body>
  <div class="container-fluid" id="grad1">
    <div class="row justify-content-center mt-0">
      <div class="col-11 col-sm-9 col-md-7 col-lg-6 p-0 mt-3 mb-2">
        <div class="card px-0 pt-4 pb-0 mt-3 mb-3">
          <table style="margin-bottom:20px">
            <tbody>
              <tr>
                <td style="text-align:right;">
                  <image width="45" src="https://s2.coinmarketcap.com/static/img/coins/64x64/52.png" /></image>
                </td>
                <td style="text-align:left;padding-left:15px;">
                  Pay with <strong><i>XRP</i></strong>
                  <p style="margin:0px">by <i>strapi xrp-cart plugin</i></p>
                </td>
              </tr>
            </tbody>
          </table>          
          <div class="row">
            <div class="col-md-12 mx-0">
              <form id="msform">
                <!-- progressbar -->
                <ul id="progressbar">
                  <li class="active" id="summary"><strong>Summary</strong></li>
                  <li id="payment"><strong>Payment</strong></li>
                  <li id="approve"><strong>Approve</strong></li>
                  <li id="finish"><strong>Finish</strong></li>
                </ul> <!-- fieldsets -->
                <fieldset>
                  <div class="form-card">
                    <h2 class="fs-title">Summary</h2>
                    <table class="table">
                      <thead>
                        <tr>
                          <th scope="col">#</th>
                          <th scope="col">Item</th>
                          <th scope="col" class="text-end">Quantity</th>
                          <th scope="col" class="text-end">Price/Unit</th>
                          <th scope="col" class="text-end"></th>
                        </tr>
                      </thead>
                      <tbody class="table-summary">
                      </tbody>
                      <tfoot>
                        <tr>
                          <th scope="col"></th>
                          <td></td>
                          <td class="text-end">Total</td>
                          <td class="text-end" id="pg1-total"></td>
                          <td></td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                  <button type="button" name="next" class="next action-button">
                    Next Step
                  </button>
                </fieldset>
                <fieldset>
                  <div class="form-card">
                    <h2 class="fs-title">Payment</h2>
                    <p>XRP address that want to use for payment...</p>
                    <input type="text" class="form-control" name="paying-address"
                      placeholder="eg. xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" />
                  </div>
                  <button type="button" name="previous" class="previous action-button-previous">
                    Previous
                  </button>
                  <button type="button" name="next" class="next action-button">
                    Next Step
                  </button>
                </fieldset>
                <fieldset>
                  <div class="form-card">
                    <h2 class="fs-title">Approve</h2>
                    <p id="approve-msg">Minting NFT...</p>
                    <ol id="approve-code">
                      <li>
                        <pre>hash: 6E823ABA8824F58EC068ADC9519512314018208C0E13E5DF05B87C2733A6A896</pre>
                      </li>
                    </ol>
                  </div>
                  <!-- <input type="button" name="previous" class="previous action-button-previous" value="Previous" /> -->
                  <button type="button" name="check_payment" class="check-accept-offer action-button">
                    Refresh
                  </button>
                  <button type="button" name="done_payment" class="finish-offer next action-button"
                    style="display:none;">
                    Finish
                  </button>
                </fieldset>
                <fieldset>
                  <div class="form-card">
                    <h2 class="fs-title text-center">Success !</h2> <br><br>
                    <div class="row justify-content-center">
                      <div class="col-3">
                        <img src="https://img.icons8.com/color/96/000000/ok--v2.png" class="fit-image">
                      </div>
                    </div> <br><br>
                    <div class="row justify-content-center">
                      <div class="col-7 text-center">
                        <h5>You Have Successfully Made the payment</h5>
                      </div>
                    </div>
                  </div>
                  <button type="button" name="close" class="action-button">
                    Close
                  </button>
                </fieldset>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Load React. -->
  <!-- Note: when deploying, replace "development.js" with "production.min.js". -->
  <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"
    integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"
    integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

  <!-- Wizard -->
  <script>
    $(document).ready(function () {
      var current_fs, next_fs, previous_fs; //fieldsets
      var opacity;
      $(".next").click(function () {

        current_fs = $(this).parent();
        next_fs = $(this).parent().next();

        //Add Class Active
        $("#progressbar li").eq($("fieldset").index(next_fs)).addClass("active");
        $("#progressbar li").eq($("fieldset").index(next_fs)).trigger('classChanged');

        //show the next fieldset
        next_fs.show();
        //hide the current fieldset with style
        current_fs.animate({ opacity: 0 }, {
          step: function (now) {
            // for making fielset appear animation
            opacity = 1 - now;

            current_fs.css({
              'display': 'none',
              'position': 'relative'
            });
            next_fs.css({ 'opacity': opacity });
          },
          duration: 600
        });
      });

      $(".previous").click(function () {

        current_fs = $(this).parent();
        previous_fs = $(this).parent().prev();

        //Remove class active
        $("#progressbar li").eq($("fieldset").index(current_fs)).removeClass("active");
        $("#progressbar li").eq($("fieldset").index(current_fs)).trigger('classChanged');

        //show the previous fieldset
        previous_fs.show();

        //hide the current fieldset with style
        current_fs.animate({ opacity: 0 }, {
          step: function (now) {
            // for making fielset appear animation
            opacity = 1 - now;

            current_fs.css({
              'display': 'none',
              'position': 'relative'
            });
            previous_fs.css({ 'opacity': opacity });
          },
          duration: 600
        });
      });

      $('.radio-group .radio').click(function () {
        $(this).parent().find('.radio').removeClass('selected');
        $(this).addClass('selected');
      });

      $(".submit").click(function () {
        return false;
      })

    });
  </script>

  <script>
    const rippleUrl = "wss://xls20-sandbox.rippletest.net:51233";
    let searchParams = new URLSearchParams(window.location.search);
    const xrpId = searchParams.get('id');
    const redir = searchParams.get('redir');
    load();

    async function load() {
      if (xrpId == null)
        return;

      const loadCartDetails = async () => {
        let storage = [];
        if (xrpId != null)
          storage = await fetchAPI('/xrp-cart/my-cart?id=' + xrpId);
        console.log(storage);

        const total = storage.reduce((t, n) => t + n.itemPrice, 0.0);
        $("#pg1-total").text("$ " + total.toFixed(2));

        $("tbody.table-summary").empty();
        storage.map((o, i) => {
          $("tbody.table-summary").append(`
            <tr>
              <th scope="row">${i + 1}</th>
              <td>${o.itemName}</td>
              <td class="text-end">1</td>
              <td class="text-end">${o.itemPrice}</td>
              <td class="text-end">
                <button class="btn delete-item" data-item-id="${o.itemId}" data-index="${i}">
                  <i class="fa fa-trash text-danger"></i>
                </button>
              </td>
            </tr>
          `);
        });
      };

      await loadCartDetails();

      $("body").on("click", ".delete-item", async function (e) {
        e.preventDefault();
        const data = $(this).data();
        await fetchAPI('/xrp-cart/remove-from-cart', {
          method: "post",
          body: JSON.stringify({ xrpId, index: data.index }),
        });
        await loadCartDetails();
      });

      let mintData;
      $("#approve").on("classChanged", async function () {
        if ($("#approve").hasClass("active")) {
          $("#approve-msg").text("Minting NFT...");
          $("#approve-code").empty();
          mintData = await fetchAPI('/xrp-cart/post-minting', {
            method: "post",
            body: JSON.stringify({ xrpId, payerAddress: $("input[name=paying-address]").val() }),
          });
          $("#approve-code").append(`<li><pre>hash: ${mintData.hash}</pre></li>`);
          $("#approve-code").append(`<li><pre>TokenID: ${mintData.TokenID}</pre></li>`);

          await new Promise(resolve => setTimeout(resolve, 1000));

          $("#approve-msg").text("Creating sell offer...");
          const offerData = await fetchAPI('/xrp-cart/post-offer', {
            method: "post",
            body: JSON.stringify({
              xrpId, TokenID: mintData.TokenID,
              payerAddress: $("input[name=paying-address]").val(),
            }),
          });
          $("#approve-code").append(`<li><pre>hash: ${offerData.hash}</pre></li>`);
          $("#approve-code").append(`<li><pre>OfferID: ${offerData.OfferID}</pre></li>`);

          $("#approve-msg").text("Click 'Refresh' once you have accepted the OfferID!");
        }
      });

      $("body").on("click", ".check-accept-offer", async function (e) {

        const client = new xrpl.Client(rippleUrl);
        await client.connect();
        console.log("Connected to Sandbox");
        const response = await client.request({
          method: "account_nfts",
          account: $("input[name=paying-address]").val(),
        })
        client.disconnect()
        console.log(response);

        if (mintData == null)
          return;

        const ntfs = response.result.account_nfts;
        const tokens = ntfs.filter(o => o.TokenID === mintData.TokenID);

        if (tokens.lengths === 0)
          return;

        $("#approve-msg").text("Thanks! We have received your payment.");
        $(".check-accept-offer").css("display", "none");
        $(".finish-offer").css("display", "inline")
      });

      $("body").on("click", "button[name=close]", async function (e) {
        window.location.href = redir
      });
    }

    function getStrapiURL(path) {
      return location.origin + `${path}`;
    }

    // Helper to make GET requests to Strapi
    async function fetchAPI(path, options = {}) {
      const requestUrl = getStrapiURL(path);
      const response = await fetch(requestUrl, options);
      const data = await response.json();
      return data;
    }

    async function getTokens() {
      const client = new xrpl.Client("wss://xls20-sandbox.rippletest.net:51233")
      await client.connect()
      console.log("Connected to Sandbox")
      const nfts = await client.request({
        method: "account_nfts",
        account: $("input[name=paying-address]").val(),
      })
      client.disconnect()
      return nfts;
    } //End of getTokens

  </script>
</body>

</html>